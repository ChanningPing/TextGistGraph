<!DOCTYPE html>
<!DOCTYPE html>
<!-- Port Arc Diagram visualization from http://homes.cs.washington.edu/~jheer/files/zoo/ex/networks/arc.html to D3.js -->
<meta charset="utf-8">
<style>
    body {
        font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        width: 960px;
        height: 500px;
        position: relative;
    }

    path {
        fill: #505050;
        fill-opacity: 0.2;
    }

    circle{
        stroke-width: 1;
    }
</style>
<body>Order:
    <select id="selectSort">
        <option value="Group">by Cluster</option>
        <option value="Frequency">by Frequency</option>
        <option value="Name">by Name</option>
    </select>
</body>

<script src="static/js/d3.min.js"></script>
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>

<script>
    // This file contains the weighted network of coappearances of characters in
    // Victor Hugo's novel "Les Miserables". Nodes represent characters as indicated
    // by the labels, and edges connect any pair of characters that appear in the
    // same chapter of the book. The values on the edges are the number of such
    // coappearances. The data on coappearances were taken from D. E. Knuth, The
    // Stanford GraphBase: A Platform for Combinatorial Computing, Addison-Wesley,
    // Reading, MA (1993).
    //
    // The group labels were transcribed from "Finding and evaluating community
    // structure in networks" by M. E. J. Newman and M. Girvan.

    var miserables = {
      nodes:[
        {nodeName:"Myriel",id:0, group:1},
{nodeName:"Napoleon",id:1, group:1},
{nodeName:"Mlle. Baptistine",id:2, group:1},
{nodeName:"Mme. Magloire",id:3, group:1},
{nodeName:"Countess de Lo",id:4, group:1},
{nodeName:"Geborand",id:5, group:1},
{nodeName:"Champtercier",id:6, group:1},
{nodeName:"Cravatte",id:7, group:1},
{nodeName:"Count",id:8, group:1},
{nodeName:"Old Man",id:9, group:1},
{nodeName:"Labarre",id:10, group:2},
{nodeName:"Valjean",id:11, group:2},
{nodeName:"Marguerite",id:12, group:3},
{nodeName:"Mme. de R",id:13, group:2},
{nodeName:"Isabeau",id:14, group:2},
{nodeName:"Gervais",id:15, group:2},
{nodeName:"Tholomyes",id:16, group:3},
{nodeName:"Listolier",id:17, group:3},
{nodeName:"Fameuil",id:18, group:3},
{nodeName:"Blacheville",id:19, group:3},
{nodeName:"Favourite",id:20, group:3},
{nodeName:"Dahlia",id:21, group:3},
{nodeName:"Zephine",id:22, group:3},
{nodeName:"Fantine",id:23, group:3},
{nodeName:"Mme. Thenardier",id:24, group:4},
{nodeName:"Thenardier",id:25, group:4},
{nodeName:"Cosette",id:26, group:5},
{nodeName:"Javert",id:27, group:4},
{nodeName:"Fauchelevent",id:28, group:0},
{nodeName:"Bamatabois",id:29, group:2},
{nodeName:"Perpetue",id:30, group:3},
{nodeName:"Simplice",id:31, group:2},
{nodeName:"Scaufflaire",id:32, group:2},
{nodeName:"Woman 1",id:33, group:2},
{nodeName:"Judge",id:34, group:2},
{nodeName:"Champmathieu",id:35, group:2},
{nodeName:"Brevet",id:36, group:2},
{nodeName:"Chenildieu",id:37, group:2},
{nodeName:"Cochepaille",id:38, group:2},
{nodeName:"Pontmercy",id:39, group:4},
{nodeName:"Boulatruelle",id:40, group:6},
{nodeName:"Eponine",id:41, group:4},
{nodeName:"Anzelma",id:42, group:4},
{nodeName:"Woman 2",id:43, group:5},
{nodeName:"Mother Innocent",id:44, group:0},
{nodeName:"Gribier",id:45, group:0},
{nodeName:"Jondrette",id:46, group:7},
{nodeName:"Mme. Burgon",id:47, group:7},
{nodeName:"Gavroche",id:48, group:8},
{nodeName:"Gillenormand",id:49, group:5},
{nodeName:"Magnon",id:50, group:5},
{nodeName:"Mlle. Gillenormand",id:51, group:5},
{nodeName:"Mme. Pontmercy",id:52, group:5},
{nodeName:"Mlle. Vaubois",id:53, group:5},
{nodeName:"Lt. Gillenormand",id:54, group:5},
{nodeName:"Marius",id:55, group:8},
{nodeName:"Baroness T",id:56, group:5},
{nodeName:"Mabeuf",id:57, group:8},
{nodeName:"Enjolras",id:58, group:8},
{nodeName:"Combeferre",id:59, group:8},
{nodeName:"Prouvaire",id:60, group:8},
{nodeName:"Feuilly",id:61, group:8},
{nodeName:"Courfeyrac",id:62, group:8},
{nodeName:"Bahorel",id:63, group:8},
{nodeName:"Bossuet",id:64, group:8},
{nodeName:"Joly",id:65, group:8},
{nodeName:"Grantaire",id:66, group:8},
{nodeName:"Mother Plutarch",id:67, group:9},
{nodeName:"Gueulemer",id:68, group:4},
{nodeName:"Babet",id:69, group:4},
{nodeName:"Claquesous",id:70, group:4},
{nodeName:"Montparnasse",id:71, group:4},
{nodeName:"Toussaint",id:72, group:5},
{nodeName:"Child 1",id:73, group:10},
{nodeName:"Child 2",id:74, group:10},
{nodeName:"Brujon",id:75, group:4},
{nodeName:"Mme. Hucheloup",id:76, group:8}
      ],
      links:[
        {source:1, target:0, value:1},
        {source:2, target:0, value:8},
        {source:3, target:0, value:10},
        {source:3, target:2, value:6},
        {source:4, target:0, value:1},
        {source:5, target:0, value:1},
        {source:6, target:0, value:1},
        {source:7, target:0, value:1},
        {source:8, target:0, value:2},
        {source:9, target:0, value:1},
        {source:11, target:10, value:1},
        {source:11, target:3, value:3},
        {source:11, target:2, value:3},
        {source:11, target:0, value:5},
        {source:12, target:11, value:1},
        {source:13, target:11, value:1},
        {source:14, target:11, value:1},
        {source:15, target:11, value:1},
        {source:17, target:16, value:4},
        {source:18, target:16, value:4},
        {source:18, target:17, value:4},
        {source:19, target:16, value:4},
        {source:19, target:17, value:4},
        {source:19, target:18, value:4},
        {source:20, target:16, value:3},
        {source:20, target:17, value:3},
        {source:20, target:18, value:3},
        {source:20, target:19, value:4},
        {source:21, target:16, value:3},
        {source:21, target:17, value:3},
        {source:21, target:18, value:3},
        {source:21, target:19, value:3},
        {source:21, target:20, value:5},
        {source:22, target:16, value:3},
        {source:22, target:17, value:3},
        {source:22, target:18, value:3},
        {source:22, target:19, value:3},
        {source:22, target:20, value:4},
        {source:22, target:21, value:4},
        {source:23, target:16, value:3},
        {source:23, target:17, value:3},
        {source:23, target:18, value:3},
        {source:23, target:19, value:3},
        {source:23, target:20, value:4},
        {source:23, target:21, value:4},
        {source:23, target:22, value:4},
        {source:23, target:12, value:2},
        {source:23, target:11, value:9},
        {source:24, target:23, value:2},
        {source:24, target:11, value:7},
        {source:25, target:24, value:13},
        {source:25, target:23, value:1},
        {source:25, target:11, value:12},
        {source:26, target:24, value:4},
        {source:26, target:11, value:31},
        {source:26, target:16, value:1},
        {source:26, target:25, value:1},
        {source:27, target:11, value:17},
        {source:27, target:23, value:5},
        {source:27, target:25, value:5},
        {source:27, target:24, value:1},
        {source:27, target:26, value:1},
        {source:28, target:11, value:8},
        {source:28, target:27, value:1},
        {source:29, target:23, value:1},
        {source:29, target:27, value:1},
        {source:29, target:11, value:2},
        {source:30, target:23, value:1},
        {source:31, target:30, value:2},
        {source:31, target:11, value:3},
        {source:31, target:23, value:2},
        {source:31, target:27, value:1},
        {source:32, target:11, value:1},
        {source:33, target:11, value:2},
        {source:33, target:27, value:1},
        {source:34, target:11, value:3},
        {source:34, target:29, value:2},
        {source:35, target:11, value:3},
        {source:35, target:34, value:3},
        {source:35, target:29, value:2},
        {source:36, target:34, value:2},
        {source:36, target:35, value:2},
        {source:36, target:11, value:2},
        {source:36, target:29, value:1},
        {source:37, target:34, value:2},
        {source:37, target:35, value:2},
        {source:37, target:36, value:2},
        {source:37, target:11, value:2},
        {source:37, target:29, value:1},
        {source:38, target:34, value:2},
        {source:38, target:35, value:2},
        {source:38, target:36, value:2},
        {source:38, target:37, value:2},
        {source:38, target:11, value:2},
        {source:38, target:29, value:1},
        {source:39, target:25, value:1},
        {source:40, target:25, value:1},
        {source:41, target:24, value:2},
        {source:41, target:25, value:3},
        {source:42, target:41, value:2},
        {source:42, target:25, value:2},
        {source:42, target:24, value:1},
        {source:43, target:11, value:3},
        {source:43, target:26, value:1},
        {source:43, target:27, value:1},
        {source:44, target:28, value:3},
        {source:44, target:11, value:1},
        {source:45, target:28, value:2},
        {source:47, target:46, value:1},
        {source:48, target:47, value:2},
        {source:48, target:25, value:1},
        {source:48, target:27, value:1},
        {source:48, target:11, value:1},
        {source:49, target:26, value:3},
        {source:49, target:11, value:2},
        {source:50, target:49, value:1},
        {source:50, target:24, value:1},
        {source:51, target:49, value:9},
        {source:51, target:26, value:2},
        {source:51, target:11, value:2},
        {source:52, target:51, value:1},
        {source:52, target:39, value:1},
        {source:53, target:51, value:1},
        {source:54, target:51, value:2},
        {source:54, target:49, value:1},
        {source:54, target:26, value:1},
        {source:55, target:51, value:6},
        {source:55, target:49, value:12},
        {source:55, target:39, value:1},
        {source:55, target:54, value:1},
        {source:55, target:26, value:21},
        {source:55, target:11, value:19},
        {source:55, target:16, value:1},
        {source:55, target:25, value:2},
        {source:55, target:41, value:5},
        {source:55, target:48, value:4},
        {source:56, target:49, value:1},
        {source:56, target:55, value:1},
        {source:57, target:55, value:1},
        {source:57, target:41, value:1},
        {source:57, target:48, value:1},
        {source:58, target:55, value:7},
        {source:58, target:48, value:7},
        {source:58, target:27, value:6},
        {source:58, target:57, value:1},
        {source:58, target:11, value:4},
        {source:59, target:58, value:15},
        {source:59, target:55, value:5},
        {source:59, target:48, value:6},
        {source:59, target:57, value:2},
        {source:60, target:48, value:1},
        {source:60, target:58, value:4},
        {source:60, target:59, value:2},
        {source:61, target:48, value:2},
        {source:61, target:58, value:6},
        {source:61, target:60, value:2},
        {source:61, target:59, value:5},
        {source:61, target:57, value:1},
        {source:61, target:55, value:1},
        {source:62, target:55, value:9},
        {source:62, target:58, value:17},
        {source:62, target:59, value:13},
        {source:62, target:48, value:7},
        {source:62, target:57, value:2},
        {source:62, target:41, value:1},
        {source:62, target:61, value:6},
        {source:62, target:60, value:3},
        {source:63, target:59, value:5},
        {source:63, target:48, value:5},
        {source:63, target:62, value:6},
        {source:63, target:57, value:2},
        {source:63, target:58, value:4},
        {source:63, target:61, value:3},
        {source:63, target:60, value:2},
        {source:63, target:55, value:1},
        {source:64, target:55, value:5},
        {source:64, target:62, value:12},
        {source:64, target:48, value:5},
        {source:64, target:63, value:4},
        {source:64, target:58, value:10},
        {source:64, target:61, value:6},
        {source:64, target:60, value:2},
        {source:64, target:59, value:9},
        {source:64, target:57, value:1},
        {source:64, target:11, value:1},
        {source:65, target:63, value:5},
        {source:65, target:64, value:7},
        {source:65, target:48, value:3},
        {source:65, target:62, value:5},
        {source:65, target:58, value:5},
        {source:65, target:61, value:5},
        {source:65, target:60, value:2},
        {source:65, target:59, value:5},
        {source:65, target:57, value:1},
        {source:65, target:55, value:2},
        {source:66, target:64, value:3},
        {source:66, target:58, value:3},
        {source:66, target:59, value:1},
        {source:66, target:62, value:2},
        {source:66, target:65, value:2},
        {source:66, target:48, value:1},
        {source:66, target:63, value:1},
        {source:66, target:61, value:1},
        {source:66, target:60, value:1},
        {source:67, target:57, value:3},
        {source:68, target:25, value:5},
        {source:68, target:11, value:1},
        {source:68, target:24, value:1},
        {source:68, target:27, value:1},
        {source:68, target:48, value:1},
        {source:68, target:41, value:1},
        {source:69, target:25, value:6},
        {source:69, target:68, value:6},
        {source:69, target:11, value:1},
        {source:69, target:24, value:1},
        {source:69, target:27, value:2},
        {source:69, target:48, value:1},
        {source:69, target:41, value:1},
        {source:70, target:25, value:4},
        {source:70, target:69, value:4},
        {source:70, target:68, value:4},
        {source:70, target:11, value:1},
        {source:70, target:24, value:1},
        {source:70, target:27, value:1},
        {source:70, target:41, value:1},
        {source:70, target:58, value:1},
        {source:71, target:27, value:1},
        {source:71, target:69, value:2},
        {source:71, target:68, value:2},
        {source:71, target:70, value:2},
        {source:71, target:11, value:1},
        {source:71, target:48, value:1},
        {source:71, target:41, value:1},
        {source:71, target:25, value:1},
        {source:72, target:26, value:2},
        {source:72, target:27, value:1},
        {source:72, target:11, value:1},
        {source:73, target:48, value:2},
        {source:74, target:48, value:2},
        {source:74, target:73, value:3},
        {source:75, target:69, value:3},
        {source:75, target:68, value:3},
        {source:75, target:25, value:3},
        {source:75, target:48, value:1},
        {source:75, target:41, value:1},
        {source:75, target:70, value:1},
        {source:75, target:71, value:1},
        {source:76, target:64, value:1},
        {source:76, target:65, value:1},
        {source:76, target:66, value:1},
        {source:76, target:63, value:1},
        {source:76, target:62, value:1},
        {source:76, target:48, value:1},
        {source:76, target:58, value:1}
      ]
    };

    var i,
        width = 3000,
        height = 1000,
        transitionTime = 2500,
        spacing = 20,
        margin = 15,
        nodeY = 500,
        nodes = miserables.nodes,
        links = miserables.links,
        colors = d3.scale.category20(),
        τ = 2 * Math.PI; // http://tauday.com/tau-manifesto

    var svg = d3.select("body").append("svg")
            .attr("width", width)
            .attr("height", height)

    function mapRange(value, inMin, inMax, outMin, outMax){
        var inVal = Math.min(Math.max(value, inMin), inMax);
        return outMin + (outMax-outMin)*((inVal - inMin)/(inMax-inMin));
    }

    // Set each node's value to the sum of all incoming and outgoing link values
    var nodeValMin = 100000000,
        nodeValMax = 0;
    for(i=0; i<nodes.length; i++){
        nodes[i].value = 0;
        nodes[i].displayOrder = i;
    }
    for(i=0; i<links.length; i++){
        var link = links[i];
            value = link.value;
        nodes[link.source].value += link.value;
        nodes[link.target].value += link.value;
    }
    for(i=0; i<nodes.length; i++){
        nodeValMin = Math.min(nodeValMin, nodes[i].value);
        nodeValMax = Math.max(nodeValMax, nodes[i].value);
    }

    var arcBuilder = d3.svg.arc()
        .startAngle(-τ/4)
        .endAngle(τ/4);
    arcBuilder.setRadii = function(d){
            var arcHeight = 0.5 * Math.abs(d.x2-d.x1);
            this
                .innerRadius(arcHeight - d.thickness/2)
                .outerRadius(arcHeight + d.thickness/2);
        };
    function arcTranslation(d){
        return "translate(" + (d.x1 + d.x2)/2 + "," + nodeY + ")";
    }
    function nodeDisplayX(node){
        return node.displayOrder * spacing + margin;
    }

    var path;

    function update(){
        // DATA JOIN
        path = svg.selectAll("path")
            .data(links);
        // UPDATE
        path.transition()
          .duration(transitionTime)
          .call(pathTween, null);
        // ENTER
        path.enter()
            .append("path")
            .attr("transform", function(d,i){
                d.x1 = nodeDisplayX(nodes[d.target]);
                d.x2 = nodeDisplayX(nodes[d.source]);
                return arcTranslation(d);
                })
            .attr("d", function(d,i){
                d.thickness = 1 + d.value;
                arcBuilder.setRadii(d);
                return arcBuilder();
                });

        // DATA JOIN
        var circle = svg.selectAll("circle")
            .data(nodes);
        // UPDATE
        circle.transition()
            .duration(transitionTime)
            .attr("cx", function(d,i) {return nodeDisplayX(d);});
        // ENTER
        circle.enter()
            .append("circle")
            .attr("cy", nodeY)
            .attr("cx", function(d,i) {return nodeDisplayX(d);})
            .attr("r", function(d,i) {return mapRange(d.value, nodeValMin, nodeValMax, 2.5, 13);})
            .attr("fill", function(d,i) {return colors(d.group);})
            //.attr("stroke", function(d,i) {return d3.rgb(colors(d.group)).darker(1);})
            .on("mouseover", nodeOver)
            .on("mouseout", nodeOut)
        //TODO: mouseout
        ;

        function nodeOver(d,i) {
            d3.selectAll("circle").style("fill", function (p) {return p == d ? "#f2734f" : "lightgray"})
            d3.selectAll("path").style("fill", function (p) {return p.source == d.id || p.target == d.id ? "#3c6da8" : "lightgray"})
        }

        function nodeOut(d,i) {
            d3.selectAll("circle").style("fill", function(d,i) {return colors(d.group);})
            d3.selectAll("path").style("fill", "grey")
        }

        function textTransform(node){
            return ("rotate(-45 " + (nodeDisplayX(node) - 5) + " " + (nodeY + 12) + ")");
        }
        // DATA JOIN
        var text = svg.selectAll("text")
            .data(nodes);
        // UPDATE
        text.transition()
            .duration(transitionTime)
            .attr("x", function(d,i) {return nodeDisplayX(d) - 5;})
            .attr("transform", function(d,i) { return textTransform(d); });
        // ENTER
        text.enter()
            .append("text")
            .attr("y", nodeY + 12)
            .attr("x", function(d,i) {return nodeDisplayX(d) - 5;})
            .attr("text-anchor", "end") // set anchor y justification
            .attr("transform", function(d,i) { return textTransform(d); })
            .attr("font-size", "10px")
            .text(function(d,i) {return d.nodeName;});
    }

    doSort(0);
    update();

    function pathTween(transition, dummy){
        transition.attrTween("d", function(d){
            var interpolateX1 = d3.interpolate(d.x1, nodeDisplayX(nodes[d.target]));
            var interpolateX2 = d3.interpolate(d.x2, nodeDisplayX(nodes[d.source]));
            return function(t){
                d.x1 = interpolateX1(t);
                d.x2 = interpolateX2(t);
                arcBuilder.setRadii(d);
                return arcBuilder();
            };
        });

        transition.attrTween("transform", function(d){
            var interpolateX1 = d3.interpolate(d.x1, nodeDisplayX(nodes[d.target]));
            var interpolateX2 = d3.interpolate(d.x2, nodeDisplayX(nodes[d.source]));
            return function(t){
                d.x1 = interpolateX1(t);
                d.x2 = interpolateX2(t);
                return arcTranslation(d);
            };
        });
    }

    d3.select("#selectSort").on("change", function() {
        doSort(this.selectedIndex);
        update();
    });

    function doSort(sortMethod){
        var nodeMap = [],
            sortFunciton;

        for(i=0; i<nodes.length; i++){
            var node = $.extend({index:i}, nodes[i]); // Shallow copy
            nodeMap.push(node);
        }

        if (sortMethod == 0){
            // GROUP
            sortFunction = function(a, b){
                return b.group - a.group;
            };
        }
        else if (sortMethod == 1){
            // FREQUENCY
            sortFunction = function(a, b){
                return b.value - a.value;
            };
        }
        else if(sortMethod == 2){
            // ALPHABETICAL
            sortFunction = function(a, b){
                return a.nodeName.localeCompare(b.nodeName)
            };
        }

        nodeMap.sort(sortFunction);
        for(i=0; i<nodeMap.length; i++){
            nodes[nodeMap[i].index].displayOrder = i;
        }
    }

</script>

</body>
</html>